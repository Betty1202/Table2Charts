# Table2Chart
This folder provides code of _Table2Chart_ model. To train Table2Chart model, it needs two steps: teacher forcing and search sampling. To evaluate Table2Chart, we provide two approaches: large scale evaluation and individual evaluation.

## Environment
We provide docker image [_betty1202/pytorch:allennlp_202105_](https://hub.docker.com/r/betty1202/pytorch/tags?page=1&ordering=last_updated) to deploy environment (dockerfile: [_dockerfile_allennlp_202105_](dockerfile_allennlp_202105)).

## Training
See details about teacher forcing and search sampling in section 3.2 of the paper.
For teacher forcing, run the following on 1 linux node:
```shell
MODEL_SAVE_PATH=../Results/Models
SUMMARY_PATH=../Results/summary
CORPUS_PATH=../Data/Excel
CHART_TYPE=<CHART-TYPE>
python -m nn_train.pretrain --model_name=cp --model_size=medium --features=all-fast --train_batch_size=512 --valid_batch_size=1024 --log_freq=100 --negative_weight=0.8 --search_type=$CHART_TYPE --input_type=$CHART_TYPE --previous_type=all --apex --model_save_path=$MODEL_SAVE_PATH --summary_path=$SUMMARY_PATH --corpus_path=$CORPUS_PATH --lang="en"
```
Note, you can choose `<CHART-TYPE>` from all, allCharts, lineChart, barChart, scatterChart, pieChart, areaChart and radarChart.

For search sampling, run the following on several linux nodes:
```shell
export NCCL_SOCKET_IFNAME=eth0
MASTER_ADDR=<MASTER-ADDR>
AMQP_ADDR=<AMQP-ADDR>
MASTER_PORT=<MASTER-PORT>
CORPUS_PATH=../Data/Excel
MODEL_SAVE_PATH=../Results/Models
PRE_MODEL_PATH=../Results/Models/<PRE-MODEL-NAME>.pt
SUMMARY_PATH=../Results/summary
CHART_TYPE=<CHART-TYPE>
python -m torch.distributed.launch --nproc_per_node=4 --nnodes=8 --node_rank=0 --master_addr=$MASTER_ADDR --master_port=$MASTER_PORT script.py --corpus_path=$CORPUS_PATH --model_size=medium --model_name cp --features=all-fast --negative_weight 0.8 --search_limits "e100-b4-na" --amqp_addr $AMQP_ADDR --epochs 10 -m $MODEL_SAVE_PATH -p $PRE_MODEL_PATH --summary_path $SUMMARY_PATH --apex --search_type $CHART_TYPE --input_type $CHART_TYPE --previous_type=all --lang="en"
```
Note, `<MASTER-ADDR>`, `<AMQP-ADDR>` and `<MASTER-PORT>` should be changed according to your own linux nodes. `<PRE-MODEL-NAME>` is the model name which is generated by teacher forcing.

## Evaluation
Large scale evaluation is to evaluate large scale corpus and calculate recall in the paper. Run the following:

```shell
CORPUS_PATH=../Data/Excel
LOG_PATH=../Results/Log
MODEL_SAVE_PATH=../Results/Models
MODEL_FILE=best-excel.pt
CHART_TYPE=<CHART-TYPE>
python test_agent_mp.py -m $MODEL_SAVE_PATH -f $MODEL_FILE --model_name cp --model_size=medium --features=all-fast --log_save_path $LOG_PATH --search_type $CHART_TYPE --input_type=$CHART_TYPE --previous_type all --nprocs 12 --nagents 32 --search_limits e100-b4-na --corpus_path=$CORPUS_PATH  --lang="en"
```
Specially, you need add `--test_whole_plotly --limit_search_group` for Plotly dataset evaluation.

Individual evaluation is to generate recommended chart list for individual table. Run the following:

```shell
PRE_MODEL_PATH=../Results/Models/best-excel.pt
DF_PATH=../Data/Example/data/0.t0.DF.json
DF_PATH=../Data/Example/embeddings/fasttext/0.EMB.json
python single_inference.py --df_path $DF_PATH --emb_path $EMB_PATH --model_path $PRE_MODEL_PATH
```